<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Qu·∫£n l√Ω c√¥ng th·ª©c n·∫•u ƒÉn</title>
<style>
  /* Reset */
  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0;
    height: 100vh;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #f7f9fc 0%, #eef2f7 100%);
    color: #333;
    transition: all 0.3s ease;
  }
  /* Layout */
  .container {
    display: flex;
    height: 100%;
    flex-direction: column;
    box-shadow: 0 0 20px rgba(0,0,0,0.05);
  }
  aside {
    width: 100%;
    background: linear-gradient(to bottom, #2c3e50, #34495e);
    color: #ecf0f1;
    padding: 15px;
    position: relative;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  .mobile-menu-toggle {
    position: absolute;
    top: 15px;
    right: 15px;
    background: transparent;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    display: none;
    transition: transform 0.3s ease;
  }
  .mobile-menu-toggle:hover {
    transform: scale(1.1);
  }
  aside h2 {
    font-weight: 700;
    margin-bottom: 15px;
    font-size: 1.4rem;
    text-align:center;
    border-bottom: 1px solid #4a6278;
    padding-bottom: 10px;
    color: #16a085;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
  }
  .search-container {
    position: relative;
    margin-bottom: 15px;
  }
  #search-recipe {
    width: 100%;
    padding: 10px 35px 10px 12px;
    border-radius: 8px;
    border: 1px solid #4a6278;
    background: rgba(255,255,255,0.1);
    color: white;
    outline: none;
    transition: all 0.3s ease;
    font-size: 0.95rem;
  }
  #search-recipe::placeholder {
    color: #bdc3c7;
  }
  #search-recipe:focus {
    border-color: #16a085;
    box-shadow: 0 0 0 2px rgba(22, 160, 133, 0.2);
    background: rgba(255,255,255,0.15);
  }
  .search-icon {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #bdc3c7;
  }
  #recipe-list {
    max-height: 200px;
    overflow-y: auto;
    padding-right: 5px;
    transition: max-height 0.3s ease;
  }
  #recipe-list.hidden {
    max-height: 0;
    overflow: hidden;
  }
  #recipe-list button {
    width: 100%;
    background: transparent;
    border: none;
    color: #ecf0f1;
    text-align: left;
    padding: 12px 15px;
    font-size: 1rem;
    border-radius: 6px;
    cursor: pointer;
    margin-bottom: 6px;
    transition: all 0.2s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    overflow: hidden;
  }
  #recipe-list button:hover {
    background: rgba(255,255,255,0.1);
    transform: translateX(3px);
  }
  #recipe-list button.active {
    background: linear-gradient(to right, #16a085, #1abc9c);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
  #recipe-list .edit-icon {
    opacity: 0;
    transition: opacity 0.2s;
    font-size: 0.9rem;
  }
  #recipe-list button:hover .edit-icon {
    opacity: 1;
  }
  #add-recipe-btn {
    background: linear-gradient(to right, #16a085, #1abc9c);
    border: none;
    color: white;
    padding: 12px;
    margin-top: 15px;
    border-radius: 6px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
  }
  #add-recipe-btn:hover {
    background: linear-gradient(to right, #13856e, #16a085);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  #add-recipe-btn:active {
    transform: translateY(0);
  }
  main {
    flex-grow: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    background: white;
  }
  .main-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 10px;
  }
  main h2 {
    font-weight: 700;
    font-size: 1.8rem;
    margin: 0;
    color: #2c3e50;
    border-bottom: 2px solid #16a085;
    padding-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .recipe-actions {
    display: flex;
    gap: 10px;
  }
  .export-btn, .copy-btn {
    background: #2980b9;
    border: none;
    color: white;
    padding: 10px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  .copy-btn {
    background: #8e44ad;
  }
  .export-btn:hover, .copy-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  .export-btn:hover {
    background: #1c5980;
  }
  .copy-btn:hover {
    background: #703688;
  }
  .table-wrapper {
    overflow-x: auto;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
  }
  th, td {
    padding: 14px 16px;
    border-bottom: 1px solid #ecf0f1;
    transition: background 0.2s ease;
  }
  th {
    background: linear-gradient(to bottom, #16a085, #1abc9c);
    color: white;
    user-select: none;
    font-weight: 600;
    text-align: center;
    position: sticky;
    top: 0;
  }
  td {
    text-align: center;
  }
  tr:hover {
    background: #f8f9fa;
  }
  /* Smaller font for S·ªë l∆∞·ª£ng and ƒê∆°n v·ªã t√≠nh columns */
  .small-text {
    font-size: 0.85rem;
  }
  td.small-text input,
  td.small-text select {
    font-size: 0.85rem;
  }
  td input, td select, td textarea {
    width: 100%;
    box-sizing: border-box;
    border: none;
    font-size: 1rem;
    padding: 8px 10px;
    background: transparent;
    color: #333;
    font-family: inherit;
    resize: vertical;
    text-align: left;
    border-radius: 4px;
    transition: all 0.2s ease;
  }
  td input:focus, td select:focus, td textarea:focus {
    outline: 2px solid #16a085;
    background: #eafaf8;
    box-shadow: 0 0 0 2px rgba(22, 160, 133, 0.2);
  }
  td textarea {
    min-height: 40px;
    font-family: inherit;
  }
  .actions-cell {
    width: 100px;
    text-align: center;
  }
  .btn {
    background: #e74c3c;
    border: none;
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    user-select: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  .btn:hover {
    background: #c0392b;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  .btn:active {
    transform: translateY(0);
  }
  #add-row-btn {
    margin-top: 15px;
    background: #2980b9;
    padding: 12px 16px;
    align-self: flex-start;
  }
  #add-row-btn:hover {
    background: #1c5980;
  }
  #delete-recipe-btn {
    margin-top: 20px;
    background: #e74c3c;
    padding: 10px 16px;
    width: auto;
    font-size: 0.95rem;
    font-weight: 600;
    align-self: flex-end;
    border-radius: 6px;
    transition: all 0.3s ease;
  }
  #delete-recipe-btn:hover {
    background: #c0392b;
  }
  /* Scrollbar for recipe list */
  #recipe-list::-webkit-scrollbar {
    width: 6px;
  }
  #recipe-list::-webkit-scrollbar-thumb {
    background: #16a085;
    border-radius: 3px;
  }
  #recipe-list::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.1);
  }
  #recipe-steps-label {
    font-weight: 700;
    margin: 25px 0 8px;
    color: #2c3e50;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  #recipe-steps {
    width: 100%;
    min-height: 120px;
    padding: 12px 14px;
    font-size: 1rem;
    border-radius: 8px;
    border: 2px solid #16a085;
    background: white;
    resize: vertical;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #333;
    transition: all 0.3s ease;
  }
  #recipe-steps:focus {
    outline: none;
    background: #eafaf8;
    box-shadow: 0 0 0 3px rgba(22, 160, 133, 0.2);
  }
  
  /* Toast notification */
  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    background: #27ae60;
    color: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    transform: translateX(120%);
    transition: transform 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .toast.show {
    transform: translateX(0);
  }
  .toast.error {
    background: #e74c3c;
  }
  
  /* Export modal */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1001;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s;
  }
  .modal.show {
    opacity: 1;
    visibility: visible;
  }
  .modal-content {
    background: white;
    border-radius: 12px;
    padding: 25px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    transform: translateY(-20px);
    transition: transform 0.3s ease;
  }
  .modal.show .modal-content {
    transform: translateY(0);
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 1px solid #eee;
    padding-bottom: 15px;
  }
  .modal-title {
    margin: 0;
    color: #2c3e50;
    font-size: 1.4rem;
  }
  .close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #7f8c8d;
    transition: color 0.2s ease;
  }
  .close-btn:hover {
    color: #e74c3c;
  }
  .export-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .export-option {
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.2s ease;
    border: 1px solid transparent;
  }
  .export-option:hover {
    background: #e9ecef;
    transform: translateY(-2px);
    border-color: #16a085;
  }
  
  /* Confirmation modal */
  .confirmation-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1002;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s;
  }
  .confirmation-modal.show {
    opacity: 1;
    visibility: visible;
  }
  .confirmation-content {
    background: white;
    border-radius: 12px;
    padding: 25px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    text-align: center;
    transform: translateY(-20px);
    transition: transform 0.3s ease;
  }
  .confirmation-modal.show .confirmation-content {
    transform: translateY(0);
  }
  .confirmation-title {
    margin: 0 0 15px;
    color: #2c3e50;
    font-size: 1.3rem;
  }
  .confirmation-message {
    margin-bottom: 25px;
    color: #7f8c8d;
    line-height: 1.5;
  }
  .confirmation-buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
  }
  .confirm-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  .confirm-delete {
    background: #e74c3c;
    color: white;
  }
  .confirm-delete:hover {
    background: #c0392b;
  }
  .cancel-btn {
    background: #95a5a6;
    color: white;
  }
  .cancel-btn:hover {
    background: #7f8c8d;
  }
  
  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #7f8c8d;
  }
  .empty-state-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
  }
  .empty-state-text {
    font-size: 1.1rem;
    margin-bottom: 20px;
  }
  
  /* Responsive */
  @media (min-width: 768px) {
    .container {
      flex-direction: row;
    }
    aside {
      width: 300px;
      min-width: 300px;
      height: 100%;
      padding: 20px 15px;
    }
    #recipe-list {
      max-height: none;
      flex-grow: 1;
    }
    .mobile-menu-toggle {
      display: none;
    }
    .main-header {
      flex-wrap: nowrap;
    }
  }
  @media (max-width: 767px) {
    .mobile-menu-toggle {
      display: block;
    }
    #recipe-list.hidden {
      display: none;
    }
    #recipe-list {
      max-height: 300px;
    }
    .table-wrapper {
      overflow-x: visible;
    }
    th, td {
      padding: 10px 12px;
      font-size: 0.9rem;
    }
    .actions-cell {
      width: 80px;
    }
    .btn {
      padding: 7px 10px;
      font-size: 0.85rem;
    }
    #add-row-btn, #delete-recipe-btn {
      font-size: 0.9rem;
    }
    .recipe-actions {
      flex-direction: column;
      width: 100%;
    }
    .export-btn, .copy-btn {
      width: 100%;
      justify-content: center;
    }
  }
</style>
</head>
<body>
<div class="container">
  <aside>
    <button class="mobile-menu-toggle" id="menu-toggle">‚ò∞</button>
    <h2>üç≥ Danh s√°ch m√≥n ƒÉn</h2>
    
    <div class="search-container">
      <input type="text" id="search-recipe" placeholder="T√¨m ki·∫øm m√≥n ƒÉn..." aria-label="T√¨m ki·∫øm m√≥n ƒÉn">
      <span class="search-icon">üîç</span>
    </div>
    
    <div id="recipe-list" role="list" aria-label="Danh s√°ch m√≥n ƒÉn"></div>
    <button id="add-recipe-btn" aria-label="Th√™m m√≥n ƒÉn m·ªõi">+ Th√™m m√≥n ƒÉn</button>
  </aside>
  
  <main>
    <div class="main-header">
      <h2 id="selected-recipe-title">üë®‚Äçüç≥ Ch·ªçn m·ªôt m√≥n ƒÉn</h2>
      <div class="recipe-actions">
        <button class="copy-btn" id="copy-btn" aria-label="Sao ch√©p c√¥ng th·ª©c">
          <span>üìã</span> Sao ch√©p
        </button>
        <button class="export-btn" id="export-btn" aria-label="Xu·∫•t c√¥ng th·ª©c">
          <span>üì§</span> Xu·∫•t c√¥ng th·ª©c
        </button>
      </div>
    </div>
    
    <div class="table-wrapper" aria-live="polite" aria-relevant="additions removals">
      <table id="ingredients-table" aria-label="B·∫£ng nguy√™n li·ªáu c√¥ng th·ª©c n·∫•u ƒÉn" tabindex="0">
        <thead>
          <tr>
            <th>Nguy√™n li·ªáu</th>
            <th class="small-text">S·ªë l∆∞·ª£ng</th>
            <th class="small-text">ƒê∆°n v·ªã t√≠nh</th>
            <th>Ghi ch√∫</th>
            <th>H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody>
          <!-- Rows go here -->
        </tbody>
      </table>
      <button id="add-row-btn" class="btn" aria-label="Th√™m nguy√™n li·ªáu">+ Th√™m nguy√™n li·ªáu</button>

      <label for="recipe-steps" id="recipe-steps-label">üë©‚Äçüç≥ C√°ch l√†m m√≥n ƒÉn</label>
      <textarea id="recipe-steps" placeholder="M√¥ t·∫£ c√°ch l√†m m√≥n ƒÉn..." aria-describedby="recipe-steps-label"></textarea>

      <button id="delete-recipe-btn" class="btn" aria-label="X√≥a m√≥n ƒÉn hi·ªán t·∫°i">üóëÔ∏è X√≥a m√≥n ƒÉn</button>
    </div>
  </main>
</div>

<!-- Toast notification -->
<div class="toast" id="toast">‚úÖ Th√†nh c√¥ng!</div>

<!-- Export modal -->
<div class="modal" id="export-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">üì§ Xu·∫•t c√¥ng th·ª©c</h3>
      <button class="close-btn" id="close-export-modal">&times;</button>
    </div>
    <div class="export-options">
      <div class="export-option" id="export-text">
        <span>üìù</span> Xu·∫•t d·∫°ng vƒÉn b·∫£n
      </div>
      <div class="export-option" id="export-print">
        <span>üñ®Ô∏è</span> In c√¥ng th·ª©c
      </div>
    </div>
  </div>
</div>

<!-- Confirmation modal -->
<div class="confirmation-modal" id="confirmation-modal">
  <div class="confirmation-content">
    <h3 class="confirmation-title">‚ö†Ô∏è X√°c nh·∫≠n x√≥a</h3>
    <p class="confirmation-message" id="confirmation-message">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√≥n ƒÉn n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
    <div class="confirmation-buttons">
      <button class="confirm-btn cancel-btn" id="cancel-delete">H·ªßy</button>
      <button class="confirm-btn confirm-delete" id="confirm-delete">X√≥a</button>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY = 'recipeManagerRecipes';
  const recipeListEl = document.getElementById('recipe-list');
  const addRecipeBtn = document.getElementById('add-recipe-btn');
  const selectedRecipeTitle = document.getElementById('selected-recipe-title');
  const ingredientsTableBody = document.querySelector('#ingredients-table tbody');
  const addRowBtn = document.getElementById('add-row-btn');
  const deleteRecipeBtn = document.getElementById('delete-recipe-btn');
  const recipeStepsTextarea = document.getElementById('recipe-steps');
  const searchInput = document.getElementById('search-recipe');
  const menuToggle = document.getElementById('menu-toggle');
  const exportBtn = document.getElementById('export-btn');
  const copyBtn = document.getElementById('copy-btn');
  const exportModal = document.getElementById('export-modal');
  const closeExportModal = document.getElementById('close-export-modal');
  const exportText = document.getElementById('export-text');
  const exportPrint = document.getElementById('export-print');
  const toast = document.getElementById('toast');
  const confirmationModal = document.getElementById('confirmation-modal');
  const confirmationMessage = document.getElementById('confirmation-message');
  const cancelDeleteBtn = document.getElementById('cancel-delete');
  const confirmDeleteBtn = document.getElementById('confirm-delete');

  const unitOptions = [
    '',
    'gam',
    'mg',
    'ml',
    'l√≠t',
    'mu·ªóng c√† ph√™',
    'mu·ªóng canh',
    'c√°i',
    'mi·∫øng',
    'qu·∫£',
    'b√°t',
    'ly'
  ];

  let recipes = [];
  let selectedRecipeIndex = null;
  let recipeToDelete = null;

  // Show toast notification
  function showToast(message, isError = false, duration = 2000) {
    toast.textContent = message;
    toast.className = 'toast';
    if (isError) {
      toast.classList.add('error');
    }
    toast.classList.add('show');
    setTimeout(() => {
      toast.classList.remove('show');
    }, duration);
  }

  // Save recipes to localStorage
  function saveRecipes() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(recipes));
    showToast('ƒê√£ l∆∞u c√¥ng th·ª©c!');
  }

  // Load recipes from localStorage
  function loadRecipes() {
    let data = localStorage.getItem(STORAGE_KEY);
    if(data) {
      try {
        const parsed = JSON.parse(data);
        if(Array.isArray(parsed)) {
          recipes = parsed;
          // Sort recipes alphabetically
          recipes.sort((a, b) => a.name.localeCompare(b.name));
        }
      } catch(e) {
        console.warn('L·ªói khi ƒë·ªçc d·ªØ li·ªáu m√≥n ƒÉn t·ª´ localStorage.', e);
      }
    }
  }

  // Render recipe list with search filtering
  function renderRecipeList() {
    recipeListEl.innerHTML = '';
    const searchTerm = searchInput.value.toLowerCase().trim();
    
    if(recipes.length === 0) {
      const emptyState = document.createElement('div');
      emptyState.className = 'empty-state';
      emptyState.innerHTML = `
        <div class="empty-state-icon">üç≥</div>
        <div class="empty-state-text">Ch∆∞a c√≥ m√≥n ƒÉn n√†o. Vui l√≤ng th√™m m√≥n.</div>
      `;
      recipeListEl.appendChild(emptyState);
      selectedRecipeTitle.textContent = 'üë®‚Äçüç≥ Ch·ªçn m·ªôt m√≥n ƒÉn';
      clearTable();
      return;
    }
    
    const filteredRecipes = recipes.filter(recipe => 
      recipe.name.toLowerCase().includes(searchTerm)
    );
    
    if(filteredRecipes.length === 0) {
      const emptyState = document.createElement('div');
      emptyState.className = 'empty-state';
      emptyState.innerHTML = `
        <div class="empty-state-icon">üîç</div>
        <div class="empty-state-text">Kh√¥ng t√¨m th·∫•y m√≥n ƒÉn ph√π h·ª£p.</div>
      `;
      recipeListEl.appendChild(emptyState);
      return;
    }
    
    filteredRecipes.forEach((recipe, idx) => {
      const originalIndex = recipes.indexOf(recipe);
      const btn = document.createElement('button');
      btn.innerHTML = `
        <span>${recipe.name || 'M√≥n ƒÉn kh√¥ng t√™n'}</span>
        <span class="edit-icon">‚úèÔ∏è</span>
      `;
      btn.className = (originalIndex === selectedRecipeIndex) ? 'active' : '';
      btn.setAttribute('data-index', originalIndex);
      btn.setAttribute('aria-selected', originalIndex === selectedRecipeIndex);
      btn.addEventListener('click', () => {
        selectRecipe(originalIndex);
      });
      
      // Double click to edit recipe name
      btn.addEventListener('dblclick', (e) => {
        e.stopPropagation();
        editRecipeName(originalIndex);
      });
      
      recipeListEl.appendChild(btn);
    });
  }

  // Clear table when no recipe selected
  function clearTable() {
    ingredientsTableBody.innerHTML = '';
    addRowBtn.style.display = 'none';
    deleteRecipeBtn.style.display = 'none';
    recipeStepsTextarea.style.display = 'none';
    recipeStepsTextarea.value = '';
    copyBtn.style.display = 'none';
    exportBtn.style.display = 'none';
  }

  // Select a recipe
  function selectRecipe(index) {
    if(index === selectedRecipeIndex) return;
    if(index < 0 || index >= recipes.length) return;
    selectedRecipeIndex = index;
    renderRecipeList();
    renderSelectedRecipe();
  }

  // Render selected recipe details
  function renderSelectedRecipe() {
    if(selectedRecipeIndex === null) {
      selectedRecipeTitle.textContent = 'üë®‚Äçüç≥ Ch·ªçn m·ªôt m√≥n ƒÉn';
      clearTable();
      return;
    }
    
    const recipe = recipes[selectedRecipeIndex];
    selectedRecipeTitle.textContent = `üç≥ ${recipe.name || 'M√≥n ƒÉn kh√¥ng t√™n'}`;

    ingredientsTableBody.innerHTML = '';
    recipe.ingredients.forEach((item, idx) => {
      const row = createIngredientRow(item, idx);
      ingredientsTableBody.appendChild(row);
    });
    
    addRowBtn.style.display = 'inline-block';
    deleteRecipeBtn.style.display = 'inline-block';
    recipeStepsTextarea.style.display = 'block';
    recipeStepsTextarea.value = recipe.cachLam || '';
    copyBtn.style.display = 'flex';
    exportBtn.style.display = 'flex';
  }

  // Create ingredient row
  function createIngredientRow(item, idx) {
    const tr = document.createElement('tr');

    // Nguy√™n li·ªáu
    const tdName = document.createElement('td');
    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.value = item.name;
    nameInput.placeholder = 'T√™n nguy√™n li·ªáu';
    nameInput.addEventListener('input', e => {
      updateIngredientField(idx, 'name', e.target.value);
    });
    tdName.appendChild(nameInput);
    tr.appendChild(tdName);

    // S·ªë l∆∞·ª£ng
    const tdQty = document.createElement('td');
    tdQty.className = 'small-text';
    const qtyInput = document.createElement('input');
    qtyInput.type = 'number';
    qtyInput.min = "0";
    qtyInput.step = "any";
    qtyInput.value = item.quantity;
    qtyInput.placeholder = 'S·ªë l∆∞·ª£ng';
    qtyInput.addEventListener('input', e => {
      updateIngredientField(idx, 'quantity', e.target.value);
    });
    tdQty.appendChild(qtyInput);
    tr.appendChild(tdQty);

    // ƒê∆°n v·ªã t√≠nh
    const tdUnit = document.createElement('td');
    tdUnit.className = 'small-text';
    const unitSelect = document.createElement('select');
    unitOptions.forEach(unit => {
      const opt = document.createElement('option');
      opt.value = unit;
      opt.textContent = unit || 'Ch·ªçn ƒë∆°n v·ªã';
      unitSelect.appendChild(opt);
    });
    unitSelect.value = item.unit || '';
    unitSelect.addEventListener('change', e => {
      updateIngredientField(idx, 'unit', e.target.value);
    });
    tdUnit.appendChild(unitSelect);
    tr.appendChild(tdUnit);

    // Ghi ch√∫
    const tdNote = document.createElement('td');
    const noteInput = document.createElement('input');
    noteInput.type = 'text';
    noteInput.value = item.note || '';
    noteInput.placeholder = 'Ghi ch√∫';
    noteInput.addEventListener('input', e => {
      updateIngredientField(idx, 'note', e.target.value);
    });
    tdNote.appendChild(noteInput);
    tr.appendChild(tdNote);

    // H√†nh ƒë·ªông
    const tdActions = document.createElement('td');
    tdActions.className = 'actions-cell';
    const delBtn = document.createElement('button');
    delBtn.className = 'btn';
    delBtn.textContent = 'X√≥a';
    delBtn.setAttribute('aria-label', `X√≥a nguy√™n li·ªáu ${item.name || 'kh√¥ng t√™n'}`);
    delBtn.addEventListener('click', () => {
      deleteIngredient(idx);
    });
    tdActions.appendChild(delBtn);
    tr.appendChild(tdActions);

    return tr;
  }

  // Update ingredient field
  function updateIngredientField(index, field, value) {
    if(selectedRecipeIndex === null) return;
    if(!recipes[selectedRecipeIndex]) return;
    if(!recipes[selectedRecipeIndex].ingredients[index]) return;
    if(field === 'quantity') {
      if(value === '') {
        recipes[selectedRecipeIndex].ingredients[index][field] = '';
      } else {
        let num = parseFloat(value);
        recipes[selectedRecipeIndex].ingredients[index][field] = isNaN(num) ? '' : num;
      }
    } else {
      recipes[selectedRecipeIndex].ingredients[index][field] = value;
    }
    saveRecipes();
  }

  // Delete ingredient
  function deleteIngredient(index) {
    if(selectedRecipeIndex === null) return;
    recipes[selectedRecipeIndex].ingredients.splice(index, 1);
    saveRecipes();
    renderSelectedRecipe();
  }

  // Add new ingredient
  function addIngredient() {
    if(selectedRecipeIndex === null) return;
    recipes[selectedRecipeIndex].ingredients.push({
      name: '',
      quantity: '',
      unit: '',
      note: ''
    });
    saveRecipes();
    renderSelectedRecipe();
  }

  // Add new recipe
  function addRecipe() {
    let newName = prompt('Nh·∫≠p t√™n m√≥n ƒÉn m·ªõi:', '');
    if(newName === null) return;
    newName = newName.trim();
    if(newName.length === 0) {
      showToast('T√™n m√≥n ƒÉn kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.', true);
      return;
    }
    if(recipes.some(r => r.name.toLowerCase() === newName.toLowerCase())) {
      showToast('M√≥n ƒÉn ƒë√£ t·ªìn t·∫°i. Vui l√≤ng ƒë·∫∑t t√™n kh√°c.', true);
      return;
    }
    const newRecipe = {
      name: newName,
      ingredients: [],
      cachLam: ''
    };
    recipes.push(newRecipe);
    saveRecipes();
    // Sort recipes alphabetically
    recipes.sort((a, b) => a.name.localeCompare(b.name));
    const newIndex = recipes.findIndex(r => r.name === newName);
    selectRecipe(newIndex);
  }

  // Edit recipe name
  function editRecipeName(index) {
    const recipe = recipes[index];
    const newName = prompt('S·ª≠a t√™n m√≥n ƒÉn:', recipe.name || '');
    if(newName === null) return;
    const trimmedName = newName.trim();
    if(trimmedName.length === 0) {
      showToast('T√™n m√≥n ƒÉn kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.', true);
      return;
    }
    if(recipes.some((r, i) => i !== index && r.name.toLowerCase() === trimmedName.toLowerCase())) {
      showToast('M√≥n ƒÉn ƒë√£ t·ªìn t·∫°i. Vui l√≤ng ƒë·∫∑t t√™n kh√°c.', true);
      return;
    }
    recipe.name = trimmedName;
    saveRecipes();
    // Sort recipes alphabetically
    recipes.sort((a, b) => a.name.localeCompare(b.name));
    const newIndex = recipes.findIndex(r => r.name === trimmedName);
    selectRecipe(newIndex);
  }

  // Delete recipe
  function deleteRecipe() {
    if(selectedRecipeIndex === null) return;
    const recipeName = recipes[selectedRecipeIndex].name || 'm√≥n ƒÉn';
    confirmationMessage.textContent = `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√≥n '${recipeName}'? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`;
    recipeToDelete = selectedRecipeIndex;
    confirmationModal.classList.add('show');
  }

  // Confirm recipe deletion
  function confirmDeleteRecipe() {
    if (recipeToDelete === null) return;
    recipes.splice(recipeToDelete, 1);
    if(recipes.length === 0) {
      selectedRecipeIndex = null;
    } else if(recipeToDelete >= recipes.length) {
      selectedRecipeIndex = recipes.length - 1;
    } else {
      selectedRecipeIndex = recipeToDelete;
    }
    saveRecipes();
    renderRecipeList();
    renderSelectedRecipe();
    recipeToDelete = null;
    confirmationModal.classList.remove('show');
    showToast('ƒê√£ x√≥a m√≥n ƒÉn!');
  }

  // Copy recipe to clipboard
  function copyRecipeToClipboard() {
    if(selectedRecipeIndex === null) return;
    const recipe = recipes[selectedRecipeIndex];
    let text = `C√¥ng th·ª©c: ${recipe.name}\n\n`;
    text += "Nguy√™n li·ªáu:\n";
    
    recipe.ingredients.forEach((ing, index) => {
      text += `${index + 1}. ${ing.name} - ${ing.quantity} ${ing.unit || ''}`;
      if (ing.note) text += ` (${ing.note})`;
      text += "\n";
    });
    
    text += "\nC√°ch l√†m:\n";
    text += recipe.cachLam || 'Ch∆∞a c√≥ h∆∞·ªõng d·∫´n c√°ch l√†m';
    
    navigator.clipboard.writeText(text)
      .then(() => {
        showToast('ƒê√£ sao ch√©p c√¥ng th·ª©c v√†o clipboard!');
      })
      .catch(err => {
        console.error('L·ªói khi sao ch√©p: ', err);
        showToast('Kh√¥ng th·ªÉ sao ch√©p c√¥ng th·ª©c', true);
      });
  }

  // Export recipe as text
  function exportAsText() {
    if(selectedRecipeIndex === null) return;
    const recipe = recipes[selectedRecipeIndex];
    let text = `C√¥ng th·ª©c: ${recipe.name}\n\n`;
    text += "Nguy√™n li·ªáu:\n";
    
    recipe.ingredients.forEach((ing, index) => {
      text += `${index + 1}. ${ing.name} - ${ing.quantity} ${ing.unit || ''}`;
      if (ing.note) text += ` (${ing.note})`;
      text += "\n";
    });
    
    text += "\nC√°ch l√†m:\n";
    text += recipe.cachLam || 'Ch∆∞a c√≥ h∆∞·ªõng d·∫´n c√°ch l√†m';
    
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${recipe.name.replace(/\s+/g, '_')}_c√¥ng_th·ª©c.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('ƒê√£ xu·∫•t c√¥ng th·ª©c!');
    exportModal.classList.remove('show');
  }

  // Print recipe
  function printRecipe() {
    if(selectedRecipeIndex === null) return;
    const recipe = recipes[selectedRecipeIndex];
    
    let printContent = `
      <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        h1 { text-align: center; color: #2c3e50; border-bottom: 2px solid #16a085; padding-bottom: 10px; }
        h2 { color: #16a085; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .steps { white-space: pre-line; margin-top: 20px; }
        @media print {
          .no-print { display: none; }
        }
      </style>
      <div class="no-print" style="text-align:center;margin-bottom:20px;">
        <button onclick="window.print()" style="padding:10px 20px;background:#16a085;color:white;border:none;border-radius:4px;cursor:pointer;">In trang</button>
        <button onclick="window.close()" style="padding:10px 20px;background:#e74c3c;color:white;border:none;border-radius:4px;cursor:pointer;margin-left:10px;">ƒê√≥ng</button>
      </div>
      <h1>${recipe.name}</h1>
      <h2>Nguy√™n li·ªáu</h2>
      <table>
        <thead>
          <tr>
            <th>Nguy√™n li·ªáu</th>
            <th>S·ªë l∆∞·ª£ng</th>
            <th>ƒê∆°n v·ªã t√≠nh</th>
            <th>Ghi ch√∫</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    recipe.ingredients.forEach(ing => {
      printContent += `
        <tr>
          <td>${ing.name}</td>
          <td>${ing.quantity}</td>
          <td>${ing.unit || ''}</td>
          <td>${ing.note || ''}</td>
        </tr>
      `;
    });
    
    printContent += `
        </tbody>
      </table>
      <h2>C√°ch l√†m</h2>
      <div class="steps">${recipe.cachLam || 'Ch∆∞a c√≥ h∆∞·ªõng d·∫´n c√°ch l√†m'}</div>
    `;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    exportModal.classList.remove('show');
  }

  // Initialize the app
  function init() {
    loadRecipes();
    renderRecipeList();
    if(recipes.length > 0) {
      selectRecipe(0);
    }
    
    // Event listeners
    recipeStepsTextarea.addEventListener('input', () => {
      if(selectedRecipeIndex === null) return;
      recipes[selectedRecipeIndex].cachLam = recipeStepsTextarea.value;
      saveRecipes();
    });
    
    addRecipeBtn.addEventListener('click', addRecipe);
    addRowBtn.addEventListener('click', addIngredient);
    deleteRecipeBtn.addEventListener('click', deleteRecipe);
    
    // Search functionality
    searchInput.addEventListener('input', renderRecipeList);
    
    // Mobile menu toggle
    menuToggle.addEventListener('click', () => {
      recipeListEl.classList.toggle('hidden');
    });
    
    // Export functionality
    exportBtn.addEventListener('click', () => {
      exportModal.classList.add('show');
    });
    
    closeExportModal.addEventListener('click', () => {
      exportModal.classList.remove('show');
    });
    
    exportText.addEventListener('click', exportAsText);
    exportPrint.addEventListener('click', printRecipe);
    
    // Copy functionality
    copyBtn.addEventListener('click', copyRecipeToClipboard);
    
    // Confirmation modal
    cancelDeleteBtn.addEventListener('click', () => {
      confirmationModal.classList.remove('show');
      recipeToDelete = null;
    });
    
    confirmDeleteBtn.addEventListener('click', confirmDeleteRecipe);
    
    // Close modals when clicking outside
    window.addEventListener('click', (e) => {
      if (e.target === exportModal) {
        exportModal.classList.remove('show');
      }
      if (e.target === confirmationModal) {
        confirmationModal.classList.remove('show');
        recipeToDelete = null;
      }
    });
  }

  // Start the app
  init();
</script>
</body>
</html>
